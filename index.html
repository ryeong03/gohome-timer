<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ë ¹ì´ì˜ í‡´ê·¼ íƒ€ì´ë¨¸ ã…‹ğŸ¬</title>
    <style>
        :root {
            --bg-color: #1e272e;
            --main-blue: #0fbcf9;
            --accent-yellow: #ffd32a;
        }
        body {
            background-color: var(--bg-color);
            color: #d2dae2;
            font-family: 'Apple SD Gothic Neo', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }
        h1 {
            font-size: 2.5rem;
            color: #808e9b;
            margin-bottom: 10px;
            user-select: none;
        }
        #dolphin-btn {
            cursor: pointer;
            font-size: 3rem;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }
        #target-display {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 1.1rem;
            margin-bottom: 30px;
            color: #4bcffa;
            border: 1px solid rgba(15, 188, 249, 0.2);
        }
        #timer {
            color: var(--main-blue);
            font-size: 4rem;
            font-weight: 700;
            letter-spacing: -1px;
            text-shadow: 0 0 30px rgba(15, 188, 249, 0.3);
        }
        .message {
            font-size: 1.4rem;
            margin-top: 25px;
            color: var(--accent-yellow);
            font-weight: 500;
        }
        #admin-panel {
            display: none;
            position: absolute;
            bottom: 50px;
            padding: 25px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--main-blue);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .admin-inputs { display: flex; gap: 12px; align-items: center; }
        input {
            background: #2f3542;
            border: 1px solid #57606f;
            color: white;
            padding: 12px;
            border-radius: 10px;
            outline: none;
            width: 70px;
            text-align: center;
        }
        input[type="password"] { width: 110px; }
        button {
            cursor: pointer;
            background: var(--main-blue);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            transition: 0.2s;
        }
        button:hover { background: #4bcffa; transform: translateY(-2px); }
    </style>
</head>
<body>

    <h1><span id="title-text">í‡´ê·¼ê¹Œì§€ ë‚¨ì€ ì‹œê°„</span> <span id="dolphin-btn">ğŸ¬</span></h1>
    <div id="target-display"> ğŸ¾ ë¡œë”© ì¤‘...</div>
    <div id="timer">0ì´ˆ</div>
    <div class="message" id="msg">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤!! ! ğŸ•µï¸â€â™€ï¸</div>

    <div id="admin-panel">
        <h3 id="admin-title" style="color: var(--accent-yellow); margin: 0 0 15px 0; font-size: 1rem;">ğŸ›  ì„¸ë ¹ ì „ìš© íƒ€ì„ ë¦¬í”Œë ˆì´ì„œ</h3>
        <div class="admin-inputs">
            <input type="number" id="hour" placeholder="ì‹œ" min="0" max="23">
            <input type="number" id="minute" placeholder="ë¶„" min="0" max="59">
            <input type="password" id="pw" placeholder="ë¹„ë°€í‚¤">
            <button onclick="updateTime()">SET</button>
        </div>
    </div>

    <script>
        let clickCount = 0;
        let clickTimer = null;
        const dolphinBtn = document.getElementById('dolphin-btn');
        const adminPanel = document.getElementById('admin-panel');
        const titleText = document.getElementById('title-text');
        const adminTitle = document.getElementById('admin-title');

        // í˜„ì¬ URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ê¸°ì¤€ìœ¼ë¡œ slug ê²°ì • (?user=se|min|tutoring)
        const params = new URLSearchParams(window.location.search);
        const userParam = params.get('user');
        let slug = 'se'; // ê¸°ë³¸ê°’: ì„¸ë ¹
        if (userParam === 'se') slug = 'se';
        else if (userParam === 'min') slug = 'min';
        else if (userParam === 'tutoring') slug = 'tutoring';

        const API_URL = window.location.origin;

        // JWT í† í° ìƒíƒœ (ë©”ëª¨ë¦¬ + ë¦¬í”„ë ˆì‹œ í† í°ì€ localStorage)
        let accessToken = "";
        let refreshToken = localStorage.getItem('refresh_token') || "";

        async function fetchWithToken(url, options = {}) {
            const opts = { ...options };
            opts.headers = { ...(opts.headers || {}) };
            if (accessToken) {
                opts.headers["Authorization"] = `Bearer ${accessToken}`;
            }

            let response = await fetch(url, opts);

            // ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ ë“±ìœ¼ë¡œ 401ì´ ë‚˜ë©´ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì¬ì‹œë„
            if (response.status === 401 && refreshToken) {
                try {
                    const refreshRes = await fetch(`${API_URL}/api/admin/refresh`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });

                    if (refreshRes.ok) {
                        const data = await refreshRes.json();
                        accessToken = data.access_token;
                        // ì›ë˜ ìš”ì²­ ë‹¤ì‹œ ì‹œë„
                        opts.headers["Authorization"] = `Bearer ${accessToken}`;
                        response = await fetch(url, opts);
                    }
                } catch (e) {
                    // ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨ ì‹œì—ëŠ” ê·¸ëŒ€ë¡œ 401 ìœ ì§€
                }
            }

            return response;
        }

        const configBySlug = {
            se: {
                pageTitle: 'ì„¸ë ¹ì´ì˜ í‡´ê·¼ íƒ€ì´ë¨¸ ã…‹ğŸ¬',
                heading: 'í‡´ê·¼ê¹Œì§€ ë‚¨ì€ ì‹œê°„',
                icon: 'ğŸ¬',
                targetPrefix: ' ğŸ’ªğŸ½ ì˜¤ëŠ˜ì˜ íƒˆì¶œ ëª©í‘œ: ',
                doneText: 'FREEDOM!! !',
                doneMessage: 'ë…¸íŠ¸ë¶ ë˜ì§€ê³  ë‹¹ì¥ ëŸ° ?ã…‹!!! ğŸƒâ€â™€ï¸ğŸ’¨âœ¨',
                runningMessage: '!! ì¡°ê¸ˆë§Œ ë” ê¸°ë‹¤ë ¹ ğŸ”¥',
                adminTitle: 'ğŸ›  ì„¸ë ¹ ì „ìš© íƒ€ì„ ë¦¬í”Œë ˆì´ì„œ',
            },
            min: {
                pageTitle: 'ë¯¸ë…• ê³µìµ í‡´ê·¼ íƒ€ì´ë¨¸',
                heading: 'ë¯¸ë…• ê³µìµ í‡´ê·¼ê¹Œì§€ ë‚¨ì€ ì‹œê°„',
                icon: 'ğŸª–',
                targetPrefix: ' ì˜¤ëŠ˜ ê³µìµ í‡´ê·¼ ëª©í‘œ: ',
                doneText: 'í‡´ê·¼!!',
                doneMessage: 'ì´ì œ ì„¸ë ¹ì´ ë§Œë‚˜ëŸ¬ ê°ˆ ì‹œê°„! ~~ ',
                runningMessage: 'ì¡°ê¸ˆë§Œ ë” ê¸°ë‹¤ë ¤ìš” ğŸ”¥',
                adminTitle: 'ğŸ›  ë¯¸ë…• ê³µìµ í‡´ê·¼ ì‹œê°„ ì„¤ì •',
            },
            tutoring: {
                pageTitle: 'ì£¼ì›ì´ ìˆ˜ì—… ì¢…ë£Œ íƒ€ì´ë¨¸',
                heading: 'ì£¼ì›ì´ ìˆ˜ì—… ë‚¨ì€ ì‹œê°„',
                icon: 'ğŸ“š',
                targetPrefix: ' ì˜¤ëŠ˜ ìˆ˜ì—… ì¢…ë£Œ: ',
                doneText: 'ìˆ˜ì—… ë!',
                doneMessage: 'ì˜¤ëŠ˜ë„ ìˆ˜ê³ í–ˆì–´ìš”! ğŸŒŸ',
                runningMessage: 'ì§‘ì¤‘í•´ì„œ ë§ˆë¬´ë¦¬ë³´ìì•„~ âœ¨',
                adminTitle: 'ğŸ›  ìˆ˜ì—… ì¢…ë£Œ ì‹œê°„ ì„¤ì •',
            },
        };

        const cfg = configBySlug[slug] || configBySlug.se;
        document.title = cfg.pageTitle;
        titleText.innerText = cfg.heading;
        dolphinBtn.textContent = cfg.icon;
        adminTitle.innerText = cfg.adminTitle;

        //  ëŒê³ ë˜ 2ë²ˆ í´ë¦­: ê´€ë¦¬ì ëª¨ë“œ ì†Œí™˜
        dolphinBtn.addEventListener('click', () => {
            clickCount++;
            dolphinBtn.style.transform = "scale(1.4) rotate(-15deg)";
            setTimeout(() => { dolphinBtn.style.transform = "scale(1) rotate(0deg)"; }, 150);

            if (clickCount === 2) {
                const isHidden = adminPanel.style.display === 'none' || adminPanel.style.display === '';
                adminPanel.style.display = isHidden ? 'block' : 'none';
                clickCount = 0;
            }
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => { clickCount = 0; }, 800);
        });

        // ê´€ë¦¬ì ì‹œê°„ ì¡°ì‘ í•¨ìˆ˜ (JWT ë¡œê·¸ì¸ + ì„¤ì • + ë¦¬í”„ë ˆì‹œ)
        async function updateTime() {
            const hour = document.getElementById('hour').value;
            const minute = document.getElementById('minute').value;
            const password = document.getElementById('pw').value;

            if(!hour || !minute) return alert("ì‹œê°„ì„ ì „ë¶€ ë‹¤ ì…ë ¥í•´ì¤˜ìš”!!");
            if(!password && !refreshToken) return alert("ë¹„ë°€í‚¤ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, ë¨¼ì € í•œ ë²ˆ ë¡œê·¸ì¸í•´ì•¼ í•´ìš”!");

            try {
                // ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°: ìƒˆë¡œ ë¡œê·¸ì¸í•´ì„œ í† í° ê°±ì‹ 
                if (password) {
                    const loginRes = await fetch(`${API_URL}/api/admin/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            slug: slug,
                            password: password
                        })
                    });

                    const loginData = await loginRes.json();
                    if (!loginRes.ok) {
                        alert(loginData.detail || "ë¡œê·¸ì¸ ì‹¤íŒ¨!");
                        return;
                    }

                    accessToken = loginData.access_token;
                    refreshToken = loginData.refresh_token;
                    if (refreshToken) {
                        localStorage.setItem('refresh_token', refreshToken);
                    }
                }

                // í† í°ìœ¼ë¡œ ì‹œê°„ ì„¤ì • (í•„ìš” ì‹œ ë‚´ë¶€ì—ì„œ ìë™ ë¦¬í”„ë ˆì‹œ)
                const response = await fetchWithToken(`${API_URL}/api/admin/set-time`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        hour: parseInt(hour),
                        minute: parseInt(minute)
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    adminPanel.style.display = 'none';
                } else {
                    alert(result.detail || "ì‹œê°„ ì„¤ì • ì‹¤íŒ¨");
                }
            } catch (e) {
                alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!! ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!! !");
            }
        }

        // ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ (H/M/S í¬ë§· ì ìš©)
        setInterval(async () => {
            try {
                const response = await fetch(`${API_URL}/api/clock-out/${slug}`);
                const data = await response.json();
                let seconds = data.seconds_left;
                
                document.getElementById("target-display").innerText = `${cfg.targetPrefix}${data.target_time}`;

                if (seconds <= 0) {
                    document.getElementById("timer").innerText = cfg.doneText;
                    document.getElementById("timer").style.color = "#ff3f34";
                    document.getElementById("msg").innerText = cfg.doneMessage;
                    document.body.style.backgroundColor = "#2d3436";
                } else {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = seconds % 60;

                    let timeString = "";
                    if (h > 0) timeString += `${h}ì‹œê°„ `;
                    if (m > 0 || h > 0) timeString += `${m}ë¶„ `;
                    timeString += `${s}ì´ˆ`;

                    document.getElementById("timer").innerText = timeString;
                    document.getElementById("msg").innerText = cfg.runningMessage;
                    document.getElementById("timer").style.color = "#0fbcf9";
                    document.body.style.backgroundColor = "#1e272e";
                }
            } catch (error) {
                document.getElementById("timer").innerText = "OFFLINE";
                document.getElementById("msg").innerText = "ì„œë²„ê°€ ì„¸ë ¹ì´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... ğŸš¨";
            }
        }, 1000);
    </script>
</body>
</html> 
